<!-- V1.0 Matt Thomas, Emory University, 2018 -->

<!-- V2.0 Jun restructured the whole scripts in October 2018, added contour selection, additonal Pilot table and highchart at the bottom. Jun Zhou, Emory Proton Center. jzhou995@gmail.com -->

<!DOCTYPE html>

<html>

<head>
  <meta charset="utf-8" />

  <!-- You can use a separate style sheet and reference it here. I've added the initial style used at the end of this file -->

  <!--<link rel='stylesheet' type='text/css' href='path_to_style_sheet_here.css'>-->

  <!-- Tab Title here -->

  <title>DVH Perturbations</title>

  <!-- google fonts -->
  <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet" />

  <!-- bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
  <!-- datatables -->
  <link rel="stylesheet" href="assets/DataTables/datatables.min.css">

</head>

<body>
  <div id="main-nav"
    class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm ">
    <h6 class="my-0 mr-md-auto font-weight-normal">RayStation Dashboard</h6>
    <nav class="my-2 my-md-0 mr-md-3">
      <!-- <a class="p-2 text-dark" href="#"></a> -->
      <div id="" name="jsonFile" enctype="multipart/form-data" method="post" class="">
        <h6 id="instructionLabel" class="my-0 mr-md-auto font-weight-normal">
          Select the patient file you would like to review:
          <span><input class="" type="file" id="fileinput" value="" onchange="loadFile();" /></span>
        </h6>
      </div>
    </nav>
  </div>

  <div class="container-fluid w-75">
    <div class="row">
      <main role="main" class="ml-sm-auto col-lg-12 px-4 ">
        <!-- Dashboard Header -->
        <div
          class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h2>Robust Plan Review</h2>
        </div>
        <!-- /Dashboard Header -->

        <!-- Patient Information Display -->
        <div class="mb-1" id="ptBlockDislay">
          <!-- Patient and Plan Information Display / Can add other info e.g., Physician, approval status, etc. as desired -->
          <div class="row">
            <div class="col-md-3 text-center">
              <label><b>Patient</b></label>
              <hr>
              <label id="patientName"></label>
            </div>
            <div class="col-md-3 text-center">
              <label><b>MRN</b></label>
              <hr>
              <label id="mrn"></label>
            </div>
            <div class="col-md-3 text-center">
              <label><b>Plan</b></label>
              <hr>
              <label id="planId"></label>
            </div>
            <div class="col-md-3 text-center">
              <la3bel><b>Beamset</b></label>
                <hr>
                <label id="BeamSetName"></label>
            </div>
          </div>
        </div>
        <!-- /Patient Information Display -->

        <!-- Placeholder for the DVH -->
        <div class="row" style="display: visible;">
          <div class="dvh col-md-9 m-auto h-100" id="dvh"></div>
        </div>
        <!-- contour checkboxes -->
        <div class="row">
          <div class="m-auto ">
            <h6 class="text-center">Available Contours</h6>
            <hr />
            <form class="" id="check-boxes">
            </form>
          </div>
        </div>
        <!-- Plan Parameters Table -->
        <div class="row ">
          <div class="col-md-12">
            <h2>Robust Planning Parameters</h2>
            <div class="table-responsive">
              <table class="table table-striped table-sm" id="plan-params-table" cellpadding="8" cellspacing="15">
                <thead>
                  <tr>
                    <th>Range [%]</th>
                    <th>Left [cm]</th>
                    <th>Right [cm]</th>
                    <th>Ant [cm]</th>
                    <th>Post [cm]</th>
                    <th>Sup [cm]</th>
                    <th>Inf [cm]</th>
                    <th>Ind. Beams?</th>
                  </tr>
                </thead>
                <tbody id="plan-params-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- /Plan Parameters Table -->
        <!-- Table Data -->
        <div class="row ">
          <div class="col-md-12">
            <!-- DVH Stats Table -->
            <h2>DVH Statistics</h2>
            <!-- original table removed -- can add back if prefer original over new table -->
            <!-- <div class="table-responsive dvh-table" style="display: none;">
              <table class="table table-striped table-sm table-fixed-6 " id="dvh-stats-table">
                <thead>
                  <tr>
                    <th>Structure</th>
                    <th>Plan</th>
                    <th>Max Dose (Gy)</th>
                    <th>Max %&#916;</th>
                    <th>D95 (Gy)</th>
                    <th>D95 %&#916;</th>
                  </tr>
                </thead>
                <tbody id="dvh-stats-tbody"></tbody>
              </table>
            </div> -->
            <div class="col-md-12">
              <table id="datatables-table" class="text-center table table-striped hover"></table>
            </div>
          </div>
        </div>
        <!-- /Table Data -->
      </main>
      <footer class="w-100 text-center my-5">&copy;Copyright 2019</footer>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
      </script>
    <!-- bootstrap -->
    <script src="assets/js/bootstrap/bootstrap.min.js"></script>

    <!-- highcharts -->
    <script src="assets/js/highcharts/highcharts.js"></script>

    <!-- datatables js -->
    <script src="assets/DataTables/datatables.min.js"></script>

    <!-- custom js -->
    <script src="assets/js/fill-table-data.js"></script>

</body>

</html>

<script type="text/javascript">
  // basic loadfile function combined with other functions to manipulate the data in the file and visualize it

  function loadFile() {
    // this first portion simply loads the file

    var input, file, fr, js;

    if (typeof window.FileReader !== "function") {
      alert("The file API isn't supported on this browser yet.");

      return;
    }

    input = document.getElementById("fileinput");

    if (!input) {
      alert("Um, couldn't find the fileinput element.");
    } else if (!input.files) {
      alert(
        "This browser doesn't seem to support the `files` property of file inputs."
      );
    } else if (!input.files[0]) {
      alert("Please select a file before clicking 'Load'");
    } else {
      file = input.files[0];

      fr = new FileReader();

      fr.onload = receivedText;

      fr.readAsText(file);
    }

    // This function will read the text in the file that is loaded, manipulate it, and create the graphs/tables

    function receivedText(e) {
      // variables
      var PlanJSONArray = JSON.parse(e.target.result);
      var planData = PlanJSONArray[0].planData;
      var chart;
      var data = [],
        nomData = [],
        pertTypes = [],
        seriesOptions = [],
        contourCategories = [];

      // create the dvh chart settings using highcharts

      // for documentation: https://www.highcharts.com/

      $(document).ready(function () {
        // constructors

        function Category(name, pertType) {
          this.name = name;
          this.visible = true;

          this.pert = pertType;
          // this.pertIsVisible = true;
        }

        function Point(category, y) {
          this.y = y;

          this.category = category;
        }

        init();

        function init() {
          contourCategories = [];

          var jsonArray = PlanJSONArray[0];

          // define plan info labels
          document.getElementById("patientName").innerHTML = jsonArray.patientName;
          document.getElementById("mrn").innerHTML = jsonArray.patientId;
          document.getElementById("planId").innerHTML = jsonArray.planName;
          document.getElementById("BeamSetName").innerHTML = jsonArray.BeamSetName;

          var structureID = []; //save all the contour names in the JSON file

          planData.forEach(function (element, i) {
            element.structureData.forEach(function (childElement, j) {
              structureID.push(new Category(childElement.structureId, element.perturbationType));
            });
          });

          contourCategories = structureID.map(function (cat, i) {
            cat.index = i;

            return cat;
          });

          //push all the pert types in all plan data (different pertubation serials) into pertTypes list

          // get pert types
          planData.forEach(function (element, i) {
            if (!pertTypes.includes(planData[i].perturbationType)) {
              pertTypes.push(planData[i].perturbationType);
            }
          });

          // get series options
          seriesOptions = fill_seriesOptions(contourCategories);

          // add checkboxes for each structure
          buildCheckBoxes();

          // collect data for tables
          planData.forEach(function (element, i) {
            element.structureData.forEach(function (childElement, j) {
              if (element.perturbationType == "Nominal") {
                nomData.push([
                  childElement.structureId,
                  element.planId,
                  parseFloat(childElement.structureMaxDose) / 100.0,
                  parseFloat(childElement.structureD95) / 100.0
                ]); //Dmax and D95 in Gy
              }
              // calculate deltas relative to nominal data
              nomData.forEach(function (val, i) {
                if (nomData[i][0] == childElement.structureId) {
                  var d95Ratio = 0;

                  var D95Gy = (
                    parseFloat(childElement.structureD95) / 100.0
                  ).toFixed(2);

                  if (nomData[i][3] != 0) {
                    d95Ratio = (
                      ((D95Gy - nomData[i][3]) / Math.abs(nomData[i][3])) *
                      100
                    ).toFixed(2);
                  }

                  var maxDose = (
                    parseFloat(childElement.structureMaxDose) / 100.0
                  ).toFixed(2);

                  var maxRatio = (
                    ((maxDose - nomData[i][2]) / Math.abs(nomData[i][2])) *
                    100
                  ).toFixed(2);

                  data.push([
                    element.structureData[j].structureId,
                    element.planId,
                    maxDose,
                    maxRatio,
                    D95Gy,
                    d95Ratio,
                    element.perturbationType,
                    childElement.structureType
                  ]);
                }
              });
            });
          });

          // fill plan parameters table
          if (jsonArray.optShifts != null) {
            // this processes the robust shift information

            var robustShiftsArr = [];

            var params = jsonArray.optShifts.replace(" ", "");

            var processedParams = params.slice(params.indexOf(":") + 2);

            var processedParamsArr = new Array();

            processedParamsArr = processedParams.split(",");

            processedParamsArr.forEach(function (val, i) {
              robustShiftsArr.push(parseFloat(val));
            });

            /*Robust Shift Order: [S, I, A, P, R, L]*/

            $("#plan-params-tbody").append(
              '<tr class="paramsRow" align="center">' +
              "<td>" +
              jsonArray.optDensity.replace('"', "") +
              "</td>" +
              "<td>" +
              robustShiftsArr[5].toFixed(1) +
              "</td>" /*left*/ +
              "<td>" +
              robustShiftsArr[4].toFixed(1) +
              "</td>" /*right*/ +
              "<td>" +
              robustShiftsArr[2].toFixed(1) +
              "</td>" /*ant*/ +
              "<td>" +
              robustShiftsArr[3].toFixed(1) +
              "</td>" /*post*/ +
              "<td>" +
              robustShiftsArr[0].toFixed(1) +
              "</td>" /*sup*/ +
              "<td>" +
              robustShiftsArr[1].toFixed(1) +
              "</td>" /*inf*/ +
              "<td>" +
              jsonArray.indBeams.replace('"', "") +
              "</td>" +
              "</tr>"
            );
          }

          // sorting data alphabetically by structure
          data.sort();

          // Create DVH Stats Table

          // get data for table
          data.forEach(function (arr, i) {
            if (data[i][7] == "Organ") {

              // If the structure is not a "Target", only populate id, plan, max dose, and max % diff (omit D95 and D95 % diff)
              dataTablesData.push([
                data[i][0],
                data[i][1],
                data[i][2],
                data[i][3],
                "--",
                "--"
              ]);
            } else {
              dataTablesData.push([
                data[i][0],
                data[i][1],
                data[i][2],
                data[i][3],
                data[i][4],
                data[i][5]
              ]);
            }

            // keeping in case other table is preferred
            // I left them there in place in the event they need to be added back.
            // console.log(data[i])

            // if (data[i][7] == "Organ") {
            //   if (data[i][1] == nomData[0][1]) {
            //     $("#dvh-stats-tbody").append(
            //       '<tr style="font-weight:bold;color:green;"><td>' +
            //       data[i][0] +
            //       "</td><td>" +
            //       data[i][1] +
            //       "</td><td>" +
            //       data[i][2] +
            //       "</td><td>" +
            //       data[i][3] +
            //       "</td><td>" +
            //       // data[i][4] + // don't need d95/d95% for non-targets
            //       "--</td><td>" +
            //       // data[i][5] + // don't need d95/d95% for non-targets
            //       "--</td></tr>"
            //     );
            //   } else if (
            //     Math.abs(parseFloat(data[i][5])) > 3.0 ||
            //     Math.abs(parseFloat(data[i][3])) > 3.0
            //   ) {
            //     var maxStyle = "";
            //     var d95Style = "";
            //     if (Math.abs(parseFloat(data[i][3])) > 10.0) {
            //       maxStyle = 'style="font-weight:bold;color:red"';
            //     }
            //     if (Math.abs(parseFloat(data[i][5])) > 3.0) {
            //       d95Style = 'style="font-weight:bold;color:red;"';
            //     }

            //     $("#dvh-stats-tbody").append(
            //       "<tr><td>" +
            //       data[i][0] +
            //       "</td><td>" +
            //       data[i][1] +
            //       "</td><td>" +
            //       data[i][2] +
            //       "</td><td " +
            //       maxStyle +
            //       ">" +
            //       data[i][3] +
            //       "</td><td>" +
            //       /*data[i][4] +*/
            //       "</td><td " +
            //       d95Style +
            //       ">" +
            //       /*data[i][5] +*/
            //       "</td></tr>"
            //     );
            //   } else {
            //     $("#dvh-stats-tbody").append(
            //       "<tr><td>" +
            //       data[i][0] +
            //       "</td><td>" +
            //       data[i][1] +
            //       "</td><td>" +
            //       data[i][2] +
            //       "</td><td>" +
            //       data[i][3] +
            //       "</td><td>--" +
            //       /*data[i][4] +*/
            //       "</td><td>--" +
            //       /*data[i][5] +*/
            //       "</td></tr>"
            //     );
            //   }
            // }

            // // If the structure is a "Target", populate all data columns
            // else {
            //   if (!data[i][4]) {
            //     d95 = "--";
            //   } else {
            //     d95 = data[i][4];
            //   }
            //   if (!data[i][5]) {
            //     delta_d95 = "--";
            //   } else {
            //     delta_d95 = data[i][5];
            //   }
            //   if (data[i][1] == nomData[0][1]) {
            //     $("#dvh-stats-tbody").append(
            //       '<tr style="font-weight:bold;color:green;"><td>' +
            //       data[i][0] +
            //       "</td><td>" +
            //       data[i][1] +
            //       "</td><td>" +
            //       data[i][2] +
            //       "</td><td>" +
            //       data[i][3] +
            //       "</td><td>" +
            //       d95 +
            //       "</td><td>" +
            //       data[i][5] +
            //       "</td></tr>"
            //     );
            //   } else if (
            //     Math.abs(parseFloat(data[i][3])) > 3.0 ||
            //     Math.abs(parseFloat(data[i][5])) > 3.0
            //   ) {
            //     var maxStyle = "";
            //     var d95Style = "";
            //     if (Math.abs(parseFloat(data[i][3])) > 10.0) {
            //       maxStyle = 'style="font-weight:bold;color:red;"';
            //     }
            //     if (Math.abs(parseFloat(data[i][5])) > 3.0) {
            //       d95Style = 'style="font-weight:bold;color:red;"';
            //     }

            //     $("#dvh-stats-tbody").append(
            //       "<tr><td>" +
            //       data[i][0] +
            //       "</td><td>" +
            //       data[i][1] +
            //       "</td><td>" +
            //       data[i][2] +
            //       "</td><td " +
            //       maxStyle +
            //       ">" +
            //       data[i][3] +
            //       "</td><td>" +
            //       data[i][4] +
            //       "</td><td " +
            //       d95Style +
            //       ">" +
            //       data[i][5] +
            //       "</td></tr>"
            //     );
            //   } else {
            //     $("#dvh-stats-tbody").append(
            //       "<tr><td>" +
            //       data[i][0] +
            //       "</td><td>" +
            //       data[i][1] +
            //       "</td><td>" +
            //       data[i][2] +
            //       "</td><td>" +
            //       data[i][3] +
            //       "</td><td>" +
            //       data[i][4] +
            //       "</td><td>" +
            //       data[i][5] +
            //       "</td></tr>"
            //     );
            //   }
            // }
          });

          //  fill data tables
          fillDataTables(dataTablesData);

          // chart options
          var chartOptions = {
            chart: {
              renderTo: "dvh",

              type: "spline",

              zoomType: "xy",

              panning: true,

              panKey: "shift",

              height: 600,

              // this will keep the x axis the same when series are removed (won't rescale)
              ignoreHiddenSeries: false
            },
            // this removes the highcharts label/credit in the lower rt hand corner
            credits: {
              enabled: false
            },

            // this disables the built in print/exporting buttons to ensure the data is not sent to HCs servers

            exporting: {
              buttons: {
                contextButton: {
                  enabled: false
                }
              }
            },

            xAxis: {
              title: {
                text: "Dose (cGy)"
              },

              floor: 0.5,

              crosshair: true,

              maxPadding: 0.02
            },

            plotOptions: {
              series: {
                marker: {
                  enabled: false
                },
                events: {
                  show: seriesShowFunction
                },

                allowPointSelect: true,

                states: {
                  hover: {
                    enabled: true,

                    lineWidth: 5
                  }
                }
              },

              boxplot: {
                fillColor: "#505053"
              },

              candlestick: {
                lineColor: "white"
              },

              errorbar: {
                color: "white"
              }
            },

            yAxis: {
              labels: {
                format: "{value} %"
              },

              floor: 0,

              ceiling: 100,

              title: {
                text: "Volume (%)"
              },

              crosshair: true,

              gridLineDashStyle: "ShortDash",

              gridLineColor: "#aaaaaa"
            },

            tooltip: {
              positioner: function () {
                return {
                  x: 100,
                  y: 0
                };
              },

              shared: true,

              useHTML: true,
              // tooltip on chart hover
              // NOTE: only one point is shown on hover because the x values are different for each series
              // this is because the dose at volume is collected as opposed to volume at dose
              // if you want each of the values to show on hover, simply collect volume at dose instead
              formatter: function () {
                var s =
                  '<table><strong style="color:#0a114a;">V' +
                  this.x +
                  " cGy:</strong>";

                // var sortedPoints = this.points.sort(function(a, b) {
                //     return a.y > b.y ? -1 : a.y < b.y ? 1 : 0;
                // });

                var sortedPoints = this.points.sort(function (a, b) {
                  return a.series.name < b.series.name ?
                    -1 :
                    a.series.name > b.series.name ?
                      1 :
                      0;
                });

                $.each(sortedPoints, function (i, point) {
                  if (point.y < 100 && point.y > 0) {
                    var last_ = point.series.name.lastIndexOf("_");
                    var plan = point.series.name.slice(0, last_);
                    var structure = point.series.name.slice(last_ + 1);
                    s +=
                      '<tr><td style="color:#0a114a;">' +
                      plan +
                      '</td><td style="color:#0a114a;">&nbsp;&nbsp;&nbsp;&nbsp;' +
                      structure +
                      '</td><td style="text-align: left; color:#0a114a">&nbsp;&nbsp;&nbsp;&nbsp;' +
                      Highcharts.numberFormat(point.y, 2, ".") +
                      "%</td></tr>";
                  }
                });
                s += "</table>";
                return s;
              }
            },

            title: {
              text: "DVH",

              x: 0
            },

            subtitle: {
              text: "Click and drag to zoom in. Hold down shift key to pan.",

              x: 0
            },
            // use this to change position of legend
            legend: {
              align: "center",
              verticalAlign: "bottom",
              itemDistance: 50,
              itemStyle: {
                color: "#0a114a",
                fontWeight: "regular"
              },
              itemHiddenStyle: {
                color: "red"
              }
            },

            // the settings for the individual series are defined below but loaded here

            series: seriesOptions
          };

          chart = new Highcharts.Chart(chartOptions);
        }

        // function to be fired when series button is toggled from hidden to visible
        function seriesShowFunction(e) {
          var structuresToIgnore = [];
          $.each($("#check-boxes input"), function (i, box) {
            var checkbox = this;
            if (!checkbox.checked && !structuresToIgnore.includes(checkbox.name)) {
              structuresToIgnore.push(checkbox.name)
            }
          });

          structuresToIgnore.forEach((s) => {
            e.target.chart.series.forEach((series) => {
              if (series.userOptions.name.includes(s) && series.data.length > 0) {
                // if not structure not selected for view
                // hide series
                series.setVisible(false, false);
              }
            });
          });
        }

        // filter data table when structure check box is toggled
        function filterDataTable() {
          // filter data table
          var newTableData = [];
          var checkedIds = getCheckedIds();
          dataTablesData.forEach((d) => {
            if (checkedIds.includes(d[0])) {
              newTableData.push(d);
            }
          });
          // destroy existing table
          $("#datatables-table").DataTable().destroy();
          // build new table
          fillDataTables(newTableData);
        }


        // checkbox toggle logic for filtering chart and data table
        $(document).on("click", "#check-boxes input", function (e) {
          var checkbox = e.target;
          var toIgnore = [];
          // get series to ignore / not toggle
          $.each(chart.series, function (i, series) {
            if (series.data.length == 0 && series.visible == false) {
              toIgnore.push(series.userOptions.name);
            }
          });

          // toggle series visibility
          $.each(chart.series, function (i, series) {
            if (series.userOptions.name.includes(e.target.id)) {
              // if not checked
              if (!e.target.checked) {
                // hide series
                series.setVisible(false, false);
              } else { // if checked
                // if linkedTo series visible
                if (!toIgnore.includes(series.userOptions.linkedTo)) {
                  series.setVisible(true, false);
                } else { // if linkedTo series not visible
                  series.setVisible(false, false);
                }
              }
            }
          });

          filterDataTable();

        });

        // get series options for chart
        function fill_seriesOptions(cat) {
          var seriesOptionsHere = [];

          pertTypes.forEach(function (ptype, h) {
            seriesOptionsHere.push({
              id: pertTypes[h],

              name: pertTypes[h],

              data: [],

              dashStyle: 'Solid',

              visible: true,

              color: "white"

            });
          });

          planData.forEach(function (element, i) {
            element.structureData.forEach(function (childElement, j) {
              var category = cat.find(
                category => category.name === childElement.structureId
              );
              if (!category.visible) {
                return;
              }
              let lineStyle = '';
              if (element.perturbationType == 'Nominal') {
                lineStyle = 'Solid';
              } else if (element.perturbationType.includes('Shift')) {
                lineStyle = 'LongDashDotDot';
              } else if (element.perturbationType.includes('Range')) {
                lineStyle = 'DashDot';
              } else if (element.perturbationType.includes('Rotation')) {
                lineStyle = 'LongDash';
              } else {
                lineStyle = 'ShortDash';
              }

              seriesOptionsHere.push({
                name: element.planId + "_" + childElement.structureId,

                data: childElement.dvh.sort(function (a, b) {
                  return a[0] - b[0];
                }),

                // dashStyle: dashStyles[i],
                dashStyle: lineStyle,

                visible: true,

                color: childElement.structureColor,

                // here we can link each line to the same perturbationType defined in the JSON format

                // this allows us to turn on/off all the structures for a given perturbation type with one click

                // this was there is only one series for each pert type

                linkedTo: element.perturbationType
              });
            });
          });

          return seriesOptionsHere;
        }

        // // filter series data
        // function filter_seriesOptions(cat) {
        //   var seriesOptionsHere = [];

        //   pertTypes.forEach(function (ptype, h) {
        //     seriesOptionsHere.push({
        //       id: pertTypes[h],

        //       name: pertTypes[h],

        //       data: [],

        //       dashStyle: 'Solid',

        //       visible: true,

        //       color: "white"

        //     });
        //   });

        //   planData.forEach(function (pdata, i) {
        //     pdata.structureData.forEach(function (sdata, j) {
        //       var category = cat.find(
        //         category => category.name === sdata.structureId
        //       );
        //       if (!category.visible) {
        //         return;
        //       }
        //       let lineStyle = '';
        //       if (pdata.perturbationType == 'Nominal') {
        //         lineStyle = 'Solid';
        //       } else if (pdata.perturbationType.includes('Shift')) {
        //         lineStyle = 'LongDashDotDot';
        //       } else if (pdata.perturbationType.includes('Range')) {
        //         lineStyle = 'DashDot';
        //       } else if (pdata.perturbationType.includes('Rotation')) {
        //         lineStyle = 'LongDash';
        //       } else {
        //         lineStyle = 'ShortDash';
        //       }

        //       seriesOptionsHere.push({
        //         name: pdata.planId + "_" + sdata.structureId,

        //         data: sdata.dvh.sort(function (a, b) {
        //           return a[0] - b[0];
        //         }),

        //         // dashStyle: dashStyles[i],
        //         dashStyle: lineStyle,

        //         visible: true,

        //         color: sdata.structureColor,

        //         // here we can link each line to the same perturbationType defined in the JSON format

        //         // this allows us to turn on/off all the structures for a given perturbation type with one click

        //         // this was there is only one series for each pert type

        //         linkedTo: pdata.perturbationType
        //       });
        //     });
        //   });

        //   return seriesOptionsHere;
        // }

        // //this part is used to display the series categories, used for linkedTo, mush keep

        // data variables

        // functions that filter data and prepare it to be displayed

        // function filterCategories() {
        //   var filteredCategories = [];

        //   $.each(contourCategories, function (i, category) {
        //     if (category.visible) {
        //       // push name only - chart.xAxis.categories requires array of String objects

        //       //filteredCategories.push(category.name);

        //       filteredCategories.push(category);
        //     }
        //   });

        //   return filteredCategories;
        // }

        // function filterSeries() {
        //   var filteredSeries = [];

        //   $.each(seriesOptions, function (i, serie) {
        //     // serie options are merged during update,

        //     // so it's enough to initialize serie object only with data property

        //     var newSeriesData = {
        //       data: []
        //     };

        //     $.each(serie.data, function (i, point) {
        //       if (point.category.visible) {
        //         newSeriesData.data.push(point);
        //       }
        //     });

        //     filteredSeries.push(newSeriesData);
        //   });

        //   return filteredSeries;
        // }

        //rebuild the chart data

        // function rebuildData() {
        //   var chart = $("#dvh").highcharts();

        //   $.each($("#check-boxes input"), function (i, box) {
        //     var checkbox = this;

        //     //var category = originalCategories.find((category) => category.name === checkbox.id);

        //     var category = contourCategories.find(
        //       category => category.name === checkbox.id
        //     );
        //     category.visible = checkbox.checked;
        //   });


        //   // // var value = checkbox.val().toLowerCase();
        //   // $("#dvh-stats-table tr").filter(function() {
        //   //   $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        //   // });

        //   // while(chart.series.length > 0){

        //   //   //chart.series[0].remove(true);

        //   //   chart.series[0].remove(false);  //I think false means don't redraw, which increase speed

        //   // }

        //   var series_index = 0;

        //   //first a couple of the series are empty, for perterb types only

        //   pertTypes.forEach(function (ptype, h) {
        //     series_index++;
        //   });

        //   planData.forEach(function (element, i) {
        //     element.structureData.forEach(function (childElement, j) {
        //       if (series_index < chart.series.length) {

        //         var category = contourCategories.find(
        //           category => category.name === childElement.structureId
        //         );
        //         category.pert = chart.series[series_index].name;
        //         category.pertIsVisible = chart.series[series_index].visible;
        //         // // console.log(category)

        //         // if (category.visible) {
        //         //   console.log(category.pert + " : " + category.pertIsVisible)
        //         // }



        //         if (category.visible) {
        //           // chart.series[series_index].setVisible(false, true);
        //           // console.log(category.name + " : " + chart.series[series_index].visible)
        //           // console.log(category.pert + " : " + category.pertIsVisible)
        //           // console.log('-------------------------------------------------------------------')
        //         } else {
        //           if (category.pertIsVisible) {
        //             // chart.series[series_index].setVisible(true, false);
        //             // console.log(category.name + " : " + chart.series[series_index].visible)
        //             // console.log(category.pert + " : " + category.pertIsVisible)
        //             // console.log('-------------------------------------------------------------------')
        //           }
        //           // chart.series[series_index].setVisible(true, false);
        //           // console.log(category.name + " : " + chart.series[series_index].visible)
        //           // console.log(category.pert + " : " + category.pertIsVisible)
        //           // console.log('-------------------------------------------------------------------')
        //         }

        //         // console.log(category)


        //         // console.log(chart.series[series_index])
        //         // if (!category.visible) {
        //         //   chart.series[series_index].setVisible(false, false);
        //         // } else {
        //         //   chart.series[series_index].setVisible(true, false);
        //         // }
        //         series_index++;
        //       }
        //     });
        //   });

        //   // var newSerie = fill_seriesOptions(contourCategories)

        //   // var chart = $('#dvh').highcharts();

        //   // while(chart.series.length > 0){

        //   //   //chart.series[0].remove(true);

        //   //   chart.series[0].remove(false);  //I think false means don't redraw, which increases speed

        //   // }

        //   // newSerie.forEach((element, index, array) => {

        //   //   chart.addSeries(element,false);

        //   // });

        //   // chart.update({

        //   //   series: newSerie

        //   //   // xAxis: {

        //   //     categories: filterCategories()

        //   //   }

        //   // });



        //   chart.redraw();

        //   //chart = new Highcharts.Chart(options);
        // }

        //create a checkbox for each category
        function buildCheckBoxes() {
          $("#check-boxes ").empty();
          added_cbs = []
          $.each(contourCategories, function (i, cat) {
            if (!added_cbs.includes(cat.name)) {
              var box =
                '<label class="ml-5 text-center"><input class="mr-1" type="checkbox" onChange="" id="' +
                String(cat.name) +
                '" name="' +
                String(cat.name) +
                '" val="' +
                String(cat.name) +
                '" checked="checked" />' +
                String(cat.name) +
                "</label>";

              $("#check-boxes ").append(box);
            }
            added_cbs.push(cat.name);

          });
        }
      });
    }
  }

  // // filter the dvh table when structures are selected/unselected
  // function filterDvhTable() {

  //   getVisibleSeries(getCheckedIds());
  //   // adapted from https://stackoverflow.com/questions/28063963/how-to-filter-records-based-on-key-click
  //   if ($('input[type="checkbox"]:checked').length > 0) {
  //     // Get ids of all checked boxes
  //     var ids = getCheckedIds();

  //     // filter data for datatable
  //     // var newTableData = [];
  //     // dataTablesData.forEach((d) => {
  //     //   if (ids.includes(d[0])) {
  //     //     newTableData.push(d);
  //     //   }
  //     // });
  //     // // destroy existing table
  //     // $("#datatables-table").DataTable().destroy();
  //     // // build new table
  //     // fillDataTables(newTableData);

  //     // keeping in case Other Table is preferred
  //     //   // Here we do two things to table rows
  //     //   // 1. We hide all
  //     //   // 2. Then we filter, show those whose value in first <td> matches checkbox value
  //     //   // Change: only hiding rows in the tbody, to keep header rows
  //     //   $('#dvh-stats-tbody tr')
  //     //     .hide() // 1
  //     //     .filter(function () { // 2
  //     //       return ids.indexOf($(this).find('td:first').text()) > -1;
  //     //     }).show();
  //     // } else {
  //     //   // Hide all
  //     //   $('#dvh-stats-tbody tr').hide();
  //   }


  // }

  function getCheckedIds() {
    let ids = [];
    // adapted from https://stackoverflow.com/questions/28063963/how-to-filter-records-based-on-key-click
    if ($('input[type="checkbox"]:checked').length > 0) {
      // Get ids of all checked boxes
      ids = $('input[type="checkbox"]:checked').map(function () {
        return this.id;
      }).get();
    }
    return ids;
  }


  // function getVisibleSeries(checkedIds) {
  //   let chart = $("#dvh").highcharts();
  //   let visibleSeries = [];

  //   // console.log(checkedIds)

  //   // checkedIds.forEach((id) => {
  //   //   $.each(chart.series, function (i, series) {
  //   //     if (series.userOptions.name.includes(id)) {
  //   //       // series.visible = true;
  //   //       if (series.userOptions.visible == true) {
  //   //         series.setVisible(false);
  //   //         console.log(series.userOptions.name)
  //   //       } else {
  //   //         series.setVisible(true);
  //   //       }
  //   //     } else {
  //   //       // series.visible = false;
  //   //       // series.setVisible();
  //   //     }
  //   //     if (series.userOptions.visible == true) {
  //   //       visibleSeries.push(series.userOptions);
  //   //     }
  //   //   });
  //   // });
  //   // chart.update({ chart: { series: visibleSeries } })

  //   // init();

  //   // console.log(visibleSeries);
  //   return visibleSeries;

  //   // let visibility = {};

  //   // $.each(chart.series, function (i, series) {
  //   //   visibility[i] = {
  //   //     "series": series.userOptions.name,
  //   //     "visible": series.userOptions.visible
  //   //   }
  //   //   // console.log(series.userOptions.visible);
  //   //   // series.userOptions.visible = false;
  //   //   // console.log(series.visible);
  //   // });
  //   // console.log(visibility);
  // }

  /* ----- need to be able to re-size the dvh chart and the table to make printing worth while ----- */
  // in progress...

  // // When printing, remove various buttons
  // function PrepareAndPrint() {
  //   $("#print").remove();

  //   $(".Buttons").remove();

  //   $(".loadPt").remove();

  //   $("#main-nav").remove();

  //   // $('#dvh').css('max-width', '500px');
  //   // var chart = $("#dvh").highcharts();
  //   // chart.redraw();

  //   window.print();
  // }
</script>