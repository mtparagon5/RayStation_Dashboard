<!-- V1.0 Matt Thomas, Emory University, 2018 -->

<!-- V2.0 Jun restructured the whole scripts in October 2018, added contour selection, additonal Pilot table and highchart at the bottom. Jun Zhou, Emory Proton Center. jzhou995@gmail.com -->

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />

    <!-- You can use a separate style sheet and reference it here. I've added the initial style used at the end of this file -->

    <!--<link rel='stylesheet' type='text/css' href='path_to_style_sheet_here.css'>-->

    <!-- Tab Title here -->

    <title>DVH Perturbations</title>

    <!-- google fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=PT+Sans"
      rel="stylesheet"
    />

    <!-- bootstrap -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
  </head>

  <body >
    <div
      id="main-nav"
      class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm "
    >
      <h6 class="my-0 mr-md-auto font-weight-normal">RayStation Dashboard</h6>
      <nav class="my-2 my-md-0 mr-md-3">
        <!-- <a class="p-2 text-dark" href="#"></a> -->
        <div
          id=""
          name="jsonFile"
          enctype="multipart/form-data"
          method="post"
          class=""
        >
          <h6 id="instructionLabel" class="my-0 mr-md-auto font-weight-normal">
            Select the patient file you would like to review:
            <span
              ><input
                class=""
                type="file"
                id="fileinput"
                value=""
                onchange="loadFile();"
            /></span>
          </h6>
        </div>
      </nav>
    </div>

    <div class="container-fluid w-75">
      <div class="row">
        <main role="main" class="ml-sm-auto col-lg-12 px-4 ">
          
          <!-- NOTE: have to get chart to resize propely in order to make printing worth while -->
          <!-- NOTE: also re-size the table  -->
          <!-- print button -->
          <!-- <button
            id="print"
            class="btn btn-outline-info btn-sm mb-2 pl-5 pr-5"
            onclick="PrepareAndPrint()"
          >
            Print
          </button> -->
          <!-- /print button -->

          <!-- Dashboard Header -->
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h2>Robust Plan Review</h2>
          </div>
          <!-- /Dashboard Header -->

          <!-- Patient Information Display -->
          <div class="mb-1" id="ptBlockDislay">
            <!-- Print Button -->

            <!-- Patient and Plan Information Display / Can add other info e.g., Physician, approval status, etc. as desired -->

            <!--<p>Physician:<span class='tabPhysician'><label id="physician"></label></span></p>-->
            <div class="row">
              <div class="col-md-3 text-center">
                <label><b>Patient</b></label>
                <hr>
                <label id="patientName"></label>
              </div>
              <div class="col-md-3 text-center">
                <label><b>MRN</b></label>
                <hr>
                <label id="mrn"></label>
              </div>
              <div class="col-md-3 text-center">
                <label><b>Plan</b></label>
                <hr>
                <label id="planId"></label>
              </div>
              <div class="col-md-3 text-center">
                <label><b>Beamset</b></label>
                <hr>
                <label id="BeamSetName"></label>
              </div>
            </div>

            <!--<p>ApprovalStatus:<span class='tabPlanStatus'><label id="approvalStatus"></label></span></p>-->
          </div>
          <!-- /Patient Information Display -->

          <!-- Placeholder for the DVH -->
          <div class="row">
            <div class="dvh col-md-9 m-auto h-100" id="dvh"></div>
          </div>
          <div class="row">
            <div class="m-auto ">
              <h6 class="text-center">Available Contours</h6>
              <hr />
              <form class="" id="check-boxes">
                <!-- <fieldset> -->
                <!-- labels are populated dynamically, don't think this is needed -->
                <!-- <label
                        ><input
                          id="CTV"
                          name="CTV"
                          val="CTV"
                          checked="checked"
                          type="checkbox"
                        />CTV</label
                      > -->

                <!-- </fieldset> -->
              </form>
            </div>
          </div>
          <div class="row ">
            <div class="col-md-12">
                <!-- <div class="col-md-12 tableData" id="tableData"> -->
                <!-- Plan Parameters Table -->
                <h2>Robust Planning Parameters</h2>
                <div class="table-responsive">
                  <table
                    class="table table-striped table-sm"
                    id="plan-params-table"
                    cellpadding="8"
                    cellspacing="15"
                  >
                    <thead>
                      <tr>
                        <th>Range [%]</th>
                        <th>Left [cm]</th>
                        <th>Right [cm]</th>
                        <th>Ant [cm]</th>
                        <th>Post [cm]</th>
                        <th>Sup [cm]</th>
                        <th>Inf [cm]</th>
                        <th>Ind. Beams?</th>
                      </tr>
                    </thead>
                    <tbody id="plan-params-tbody"></tbody>
                  </table>
                </div>
              </div>
            </div class="row ">
            <div class="row ">
              <div class="col-md-12">


                <!-- //     "<tr>" +
                    //     '<th rowspan="1" align="center">Range [%]</th>' +
                    //     '<th rowspan="1" align="center">Left [cm]</th>' +
                    //     '<th rowspan="1" align="center">Right [cm]</th>' +
                    //     '<th rowspan="1" align="center">Ant [cm]</th>' +
                    //     '<th rowspan="1" align="center">Post [cm]</th>' +
                    //     '<th rowspan="1" align="center">Sup [cm]</th>' +
                    //     '<th rowspan="1" align="center">Inf [cm]</th>' +
                    //     '<th rowspan="1" align="center">Ind. Beams?</th>' +
                    //     "</tr></thead>" -->

                <!-- DVH Stats Table -->

                <!-- <table id="table" cellpadding="8" cellspacing="15"></table> -->
                <h2>DVH Statistics</h2>
                <div class="table-responsive dvh-table">
                  <table
                    class="table table-striped table-sm table-fixed-6 "
                    id="dvh-stats-table"
                  >
                    <thead>
                      <tr>
                        <th>Structure</th>
                        <th>Plan</th>
                        <th>Max Dose (Gy)</th>
                        <th>Max %&#916;</th>
                        <th>D95 (Gy)</th>
                        <th>D95 %&#916;</th>
                      </tr>
                    </thead>
                    <tbody id="dvh-stats-tbody"></tbody>
                  </table>
                </div>
                <!-- </div> -->
            </div>
          </div>

            <!-- Placeholder for Table Data -->
            

        <table style="display:none;">
          <tr>
            <td style="width: 800px;">
              <div id="wdr-component"></div>
            </td>

            <td>
              <div
                id="highchartsContainer"
                style="width:700px;height:400px;"
              ></div>
            </td>
          </tr>
        </table>

        <canvas style="display:none;"
          class="my-4 w-100 mb-10"
          id="myChart"
          width="900"
          height="380"
        ></canvas>

        <!-- <h2>DVH Statistics</h2>
        <div class="table-responsive col-md-5">
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th>Structure</th>
                <th>Plan</th>
                <th>Max Dose (Gy)</th>
                <th>Max %&#916;</th>
                <th>D95 (Gy)</th>
                <th>D95 %&#916;</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div> -->
        
        </main>
        <footer class="w-100 text-center my-5">&copy;Copyright 2019</footer>
    </div>

    <!-- jQuery -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <!-- Scripts used to reference highcharts and jquery -->

    <script src="https://code.highcharts.com/highcharts.js"></script>

    <!--when use: var chart = $('#dvh').highcharts(); got error: $(...).highcharts is not a function. It's because the following jquery reimported, and confick with the previous version-->

    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>-->

    <link
      href="https://cdn.webdatarocks.com/latest/webdatarocks.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.webdatarocks.com/latest/webdatarocks.toolbar.min.js"></script>

    <script src="https://cdn.webdatarocks.com/latest/webdatarocks.js"></script>

    <script src="https://cdn.webdatarocks.com/latest/webdatarocks.highcharts.js"></script>
  </body>
</html>

<script type="text/javascript">
  // basic loadfile function combined with other functions to manipulate the data in the file and visualize it

  function loadFile() {
    // this first portion simply loads the file

    var input, file, fr, js;

    if (typeof window.FileReader !== "function") {
      alert("The file API isn't supported on this browser yet.");

      return;
    }

    input = document.getElementById("fileinput");

    if (!input) {
      alert("Um, couldn't find the fileinput element.");
    } else if (!input.files) {
      alert(
        "This browser doesn't seem to support the `files` property of file inputs."
      );
    } else if (!input.files[0]) {
      alert("Please select a file before clicking 'Load'");
    } else {
      file = input.files[0];

      fr = new FileReader();

      fr.onload = receivedText;

      fr.readAsText(file);
    }

    // This function will read the text in the file that is loaded, manipulate it, and create the graphs/tables

    function receivedText(e) {
      let lines = e.target.result;

      var PlanJSONArray = JSON.parse(lines);

      var pertTypes2 = [];

      var seriesOptions2 = [];

      var planData = PlanJSONArray[0].planData;

      var contourCategories = [];

      var chart;

      var data = [],
        nomData = [];

      var JSON_Data = [];

      // create the dvh chart settings using highcharts

      // for documentation: https://www.highcharts.com/

      $(document).ready(function() {
        // constructors

        function Category(name) {
          this.name = name;

          this.visible = true;
        }

        function Point(category, y) {
          this.y = y;

          this.category = category;
        }

        init();

        var pivot = new WebDataRocks({
          container: "#wdr-component",

          toolbar: true,

          report: {
            conditions: [
              {
                formula: "#value > 3.0",

                format: {
                  backgroundColor: "#FFEB3B",

                  color: "#000000",

                  fontFamily: "Arial",

                  fontSize: "12px"
                }
              },

              {
                formula: "#value < -3.0",

                format: {
                  backgroundColor: "#03A9F4",

                  color: "#000000",

                  fontFamily: "Arial",

                  fontSize: "12px"
                }
              }
            ],

            dataSource: {
              dataSourceType: "json",

              data: getJSONData()
            },

            options: {
              grid: {
                //showGrandTotals: false  //when use, the chart show repeat itself
              }
            },

            formats: [
              {
                name: "rating",

                decimalPlaces: 2
              }
            ],

            slice: {
              rows: [
                {
                  uniqueName: "Structure"
                },

                {
                  uniqueName: "Type"
                }
              ],

              // columns: [{

              //         uniqueName: "PerturbType"

              //     },

              //     {

              //         uniqueName: "Delta D95"

              //     }

              // ],

              columns: [],

              measures: [
                {
                  uniqueName: "Delta D95",

                  aggregation: "min",

                  format: "rating"
                },

                {
                  uniqueName: "Delta Max",

                  aggregation: "max",

                  format: "rating"
                }
              ]
            }
          },

          reportcomplete: function() {
            pivot.off("reportcomplete");

            createChart();
          }
        });

        function createChart() {
          pivot.highcharts.getData(
            {
              type: "column",

              //type: "boxplot",

              slice: {
                rows: [
                  {
                    uniqueName: "Structure"
                  }
                ],

                columns: [
                  {
                    uniqueName: "[Measures]"
                  }
                ],

                measures: [
                  {
                    uniqueName: "D95",

                    aggregation: "average"
                  }
                ],

                sorting: {
                  column: {
                    type: "desc",

                    tuple: [],

                    measure: "D95"
                  }
                }
              }
            },
            createAndUpdate,
            createAndUpdate
          );
        }

        function createAndUpdate(data, rawData) {
          if (data.series != undefined) {
            data.series[data.series.length - 1].type = "spline";
          }

          data.tooltip = {
            headerFormat: "<b>{series.name}</b><br/>",

            pointFormat: pivot.highcharts.getPointYFormat(
              rawData.meta.formats[0]
            )
          };

          //data.chart.type = 'boxplot';

          Highcharts.chart("highchartsContainer", data);
        }

        function getJSONData() {
          return JSON_Data;

          // return [

          //   {"PlanID":"NominalPlan", "PerturbType":"Nominal", "Structure":"CTV54", "structureColor":"rgb(238,0,255)", "Type":"CTV", "MaxDose":5714.76, "D95":5458.97, "Delta Max": 3.8, "Delta D95": 4},

          //   {"PlanID":"NominalPlan", "PerturbType":"Nominal","Structure":"BrainStem", "structureColor":"rgb(255,210,0)", "Type":"Organ", "MaxDose":5244.33, "D95":3.42, "Delta Max": 3.8, "Delta D95": -4},

          //   {"PlanID":"NominalPlan", "PerturbType":"Nominal", "Structure":"Chiasm", "structureColor":"rgb(0,255,255)", "Type":"Organ", "MaxDose":5436.73, "D95":4210.53, "Delta Max": -3.8, "Delta D95": 5},

          //   {"PlanID":"NominalPlan", "PerturbType":"Nominal", "Structure":"Globe_L", "structureColor":"rgb(128,0,255)", "Type":"Organ", "MaxDose":3495.08, "D95":41.89, "Delta Max": 2.8, "Delta D95": 6},

          //   {"PlanID":"NominalPlan", "PerturbType":"Nominal", "Structure":"Globe_R", "structureColor":"rgb(0,255,255)", "Type":"Organ", "MaxDose":3129.7, "D95":122.57, "Delta Max": 3.8, "Delta D95": 8},

          //   {"PlanID":"NominalPlan", "PerturbType":"Nominal", "Structure":"OpticNerve_L", "structureColor":"rgb(255,186,172)", "Type":"Organ", "MaxDose":5674.02, "D95":1255.11, "Delta Max": -2.8, "Delta D95": 4.8},

          //   {"PlanID":"NominalPlan", "PerturbType":"Nominal", "Structure":"OpticNerve_R", "structureColor":"rgb(186,53,0)", "Type":"Organ", "MaxDose":5450.99, "D95":1760.7, "Delta Max": 3.8, "Delta D95": 9},

          //   {"PlanID":"X_+3mm", "PerturbType":"3mm Shift", "Structure":"CTV54", "structureColor":"rgb(238,0,255)", "Type":"CTV", "MaxDose":5720.14, "D95":5456.85, "Delta Max": -6.8, "Delta D95": 4},

          //   {"PlanID":"X_+3mm", "PerturbType":"3mm Shift", "Structure":"BrainStem", "structureColor":"rgb(255,210,0)", "Type":"Organ", "MaxDose":4469.54, "D95":1.22, "Delta Max": 3.8, "Delta D95": 7},

          //   {"PlanID":"X_+3mm", "PerturbType":"3mm Shift", "Structure":"Chiasm", "structureColor":"rgb(0,255,255)", "Type":"Organ", "MaxDose":5265.35, "D95":2161.13, "Delta Max": 8, "Delta D95": 4},

          //   {"PlanID":"X_+3mm", "PerturbType":"3mm Shift", "Structure":"Globe_L", "structureColor":"rgb(128,0,255)", "Type":"Organ", "MaxDose":3278.34, "D95":29.26, "Delta Max": -3.5, "Delta D95": 7},

          //   {"PlanID":"X_+3mm", "PerturbType":"3mm Shift", "Structure":"Globe_R", "structureColor":"rgb(0,255,255)", "Type":"Organ", "MaxDose":"3055.89", "D95":"98.86", "Delta Max": 5.8, "Delta D95": 4.5},

          //   {"PlanID":"X_+3mm", "PerturbType":"3mm Shift", "Structure":"OpticNerve_L", "structureColor":"rgb(255,186,172)", "Type":"Organ", "MaxDose":5126.97, "D95":727.17, "Delta Max": -3.3, "Delta D95": 6.2},

          //   {"PlanID":"X_+3mm", "PerturbType":"3mm Shift", "Structure":"OpticNerve_R", "structureColor":"rgb(186,53,0)", "Type":"Organ", "MaxDose":5312.96, "D95":1681.18, "Delta Max": 4.8, "Delta D95": -4}

          // ]
        }

        function init() {
          contourCategories = [];

          var jsonArray = PlanJSONArray[0];

          //document.getElementById('physician').innerHTML = jsonArray.primaryPhysician;

          //document.getElementById('approvalStatus').innerHTML = jsonArray.planData[0].approvalStatus;

          // you can use the console.log() function to write information to the console (F12 Develepor Tools in your browser) as a test

          // NOTE: ensure you remove any console.log() functions that write PHI to the console as anyone can access a browsers console.

          // examples

          //console.log(jsonArray.planData);

          //console.log(jsonArray.planData[0].structureData[0].dvh);

          document.getElementById("patientName").innerHTML = jsonArray.patientName;

          document.getElementById("mrn").innerHTML = jsonArray.patientId;

          document.getElementById("planId").innerHTML = jsonArray.planName;

          document.getElementById("BeamSetName").innerHTML = jsonArray.BeamSetName;

          var structureID = []; //save all the contour names in the JSON file

          planData[0].structureData.forEach(function(element, i) {
            structureID.push(new Category(element.structureId));
          });

          contourCategories = structureID.map(function(cat, i) {
            cat.index = i;

            return cat;
          });

          //push all the pert types in all plan data (different pertubation serials) into pertTypes2 list

          planData.forEach(function(element, i) {
            if (!pertTypes2.includes(planData[i].perturbationType)) {
              pertTypes2.push(planData[i].perturbationType);
            }
          });

          seriesOptions2 = fill_seriesOptions(contourCategories);

          buildCheckBoxes();

          planData.forEach(function(element, i) {
            element.structureData.forEach(function(childElement, j) {
              if (element.perturbationType == "Nominal") {
                nomData.push([
                  childElement.structureId,
                  element.planId,
                  parseFloat(childElement.structureMaxDose) / 100.0,
                  parseFloat(childElement.structureD95) / 100.0
                ]); //Dmax and D95 in Gy
              }

              // JSON_Data.push({"PlanID":element.planId, "PerturbType":element.perturbationType, "Structure":childElement.structureId, "Type":childElement.structureType, "MaxDose": parseFloat(childElement.structureMaxDose), "Delta Max": 0, "D95": parseFloat(childElement.structureD95), "Delta D95": 0});

              nomData.forEach(function(val, i) {
                if (nomData[i][0] == childElement.structureId) {
                  var d95Ratio = 0;

                  var D95Gy = (
                    parseFloat(childElement.structureD95) / 100.0
                  ).toFixed(2);

                  if (nomData[i][3] == 0) {
                    //d95Ratio = "Nominal is 0";

                    // d95Ratio = -1; //JZ changed so that all are numbers
                    
                    // d95Ratio = '--';
                  } else {
                    d95Ratio = (
                      ((D95Gy - nomData[i][3]) / Math.abs(nomData[i][3])) *
                      100
                    ).toFixed(2);
                  }

                  var maxDose = (
                    parseFloat(childElement.structureMaxDose) / 100.0
                  ).toFixed(2);

                  var maxRatio = (
                    ((maxDose - nomData[i][2]) / Math.abs(nomData[i][2])) *
                    100
                  ).toFixed(2);

                  data.push([
                    element.structureData[j].structureId,
                    element.planId,
                    maxDose,
                    maxRatio,

                    D95Gy,
                    d95Ratio,
                    element.perturbationType,
                    childElement.structureType
                  ]);
                }
              });
            });
          });

          // not sure this is necessary
          // $("#plan-params-table tbody").empty();

          if (jsonArray.optShifts != null) {
            // this processes the robust shift information

            var robustShiftsArr = [];

            var params = jsonArray.optShifts.replace(" ", "");

            //console.log(params);

            var processedParams = params.slice(params.indexOf(":") + 2);

            //console.log(processedParams);

            var processedParamsArr = new Array();

            processedParamsArr = processedParams.split(",");

            processedParamsArr.forEach(function(val, i) {
              robustShiftsArr.push(parseFloat(val));
            });

            /*Robust Shift Order: [S, I, A, P, R, L]*/

            $("#plan-params-tbody").append(
              '<tr class="paramsRow" align="center">' +
              "<td>" +
              jsonArray.optDensity.replace('"', "") +
              "</td>" +
              "<td>" +
              robustShiftsArr[5].toFixed(1) +
              "</td>" /*left*/ +
              "<td>" +
              robustShiftsArr[4].toFixed(1) +
              "</td>" /*right*/ +
              "<td>" +
              robustShiftsArr[2].toFixed(1) +
              "</td>" /*ant*/ +
              "<td>" +
              robustShiftsArr[3].toFixed(1) +
              "</td>" /*post*/ +
              "<td>" +
              robustShiftsArr[0].toFixed(1) +
              "</td>" /*sup*/ +
              "<td>" +
              robustShiftsArr[1].toFixed(1) +
              "</td>" /*inf*/ +
                "<td>" +
                jsonArray.indBeams.replace('"', "") +
                "</td>" +
                "</tr>"
            );
          }

          // sorting data alphabetically by structure

          data = data.sort();

          // Create DVH Stats Table

          // don't think this is necessary anymore
          // $("#table tbody").empty();

          data.forEach(function(arr, i) {
            JSON_Data.push({
              Structure: data[i][0],
              PlanID: data[i][1],
              MaxDose: data[i][2],
              "Delta Max": data[i][3],
              D95: data[i][4],
              "Delta D95": data[i][5],
              PerturbType: data[i][6],
              Type: data[i][7]
            });

            // If the structure is not a "Target", only populate id, plan, max dose, and max % diff (omit D95 and D95 % diff)

            // I left them there in place in the event they need to be added back.

            if (data[i][7] == "Organ") {
              if (data[i][1] == nomData[0][1]) {
                $("#dvh-stats-tbody").append(
                  '<tr style="font-weight:bold;color:green;"><td>' +
                    data[i][0] +
                    "</td><td>" +
                    data[i][1] +
                    "</td><td>" +
                    data[i][2] +
                    "</td><td>" +
                    data[i][3] +
                    "</td><td>" +
                    // data[i][4] + // don't need d95/d95% for non-targets
                    "--</td><td>" +
                    // data[i][5] + // don't need d95/d95% for non-targets
                    "--</td></tr>"
                );
              } else if (
                Math.abs(parseFloat(data[i][5])) > 3.0 ||
                Math.abs(parseFloat(data[i][3])) > 3.0
              ) {
                var maxStyle = "";
                var d95Style = "";
                if (Math.abs(parseFloat(data[i][3])) > 10.0) {
                  maxStyle = 'style="font-weight:bold;color:red"';
                }
                if (Math.abs(parseFloat(data[i][5])) > 3.0) {
                  d95Style = 'style="font-weight:bold;color:red;"';
                }

                $("#dvh-stats-tbody").append(
                  "<tr><td>" +
                    data[i][0] +
                    "</td><td>" +
                    data[i][1] +
                    "</td><td>" +
                    data[i][2] +
                    "</td><td " +
                    maxStyle +
                    ">" +
                    data[i][3] +
                    "</td><td>" +
                    /*data[i][4] +*/ "</td><td " +
                    d95Style +
                    ">" +
                    /*data[i][5] +*/ "</td></tr>"
                );
              } else {
                $("#dvh-stats-tbody").append(
                  "<tr><td>" +
                    data[i][0] +
                    "</td><td>" +
                    data[i][1] +
                    "</td><td>" +
                    data[i][2] +
                    "</td><td>" +
                    data[i][3] +
                    "</td><td>--" +
                    /*data[i][4] +*/ "</td><td>--" +
                    /*data[i][5] +*/ "</td></tr>"
                );
              }
            }

            // If the structure is a "Target", populate all data columns
            else {
              if (!data[i][4]) {
                d95 = "--";
              } else {
                d95 = data[i][4];
              }
              if (!data[i][5]) {
                delta_d95 = "--";
              } else {
                delta_d95 = data[i][5];
              }
              if (data[i][1] == nomData[0][1]) {
                $("#dvh-stats-tbody").append(
                  '<tr style="font-weight:bold;color:green;"><td>' +
                    data[i][0] +
                    "</td><td>" +
                    data[i][1] +
                    "</td><td>" +
                    data[i][2] +
                    "</td><td>" +
                    data[i][3] +
                    "</td><td>" +
                    d95 +
                    "</td><td>" +
                    data[i][5] +
                    "</td></tr>"
                );
              } else if (
                Math.abs(parseFloat(data[i][3])) > 3.0 ||
                Math.abs(parseFloat(data[i][5])) > 3.0
              ) {
                var maxStyle = "";
                var d95Style = "";
                if (Math.abs(parseFloat(data[i][3])) > 10.0) {
                  maxStyle = 'style="font-weight:bold;color:red;"';
                }
                if (Math.abs(parseFloat(data[i][5])) > 3.0) {
                  d95Style = 'style="font-weight:bold;color:red;"';
                }

                $("#dvh-stats-tbody").append(
                  "<tr><td>" +
                    data[i][0] +
                    "</td><td>" +
                    data[i][1] +
                    "</td><td>" +
                    data[i][2] +
                    "</td><td " +
                    maxStyle +
                    ">" +
                    data[i][3] +
                    "</td><td>" +
                    data[i][4] +
                    "</td><td " +
                    d95Style +
                    ">" +
                    data[i][5] +
                    "</td></tr>"
                );
              } else {
                $("#dvh-stats-tbody").append(
                  "<tr><td>" +
                    data[i][0] +
                    "</td><td>" +
                    data[i][1] +
                    "</td><td>" +
                    data[i][2] +
                    "</td><td>" +
                    data[i][3] +
                    "</td><td>" +
                    data[i][4] +
                    "</td><td>" +
                    data[i][5] +
                    "</td></tr>"
                );
              }
            }
          });

          // the options are defined in a dictionary object essentially and then loaded after to simplify the code that creates the chart

          var options = {
            chart: {
              renderTo: "dvh",

              type: "spline",

              zoomType: "xy",

              panning: true,

              panKey: "shift",

              height: 600,

              // this will keep the x axis the same when series are removed (won't rescale)
              ignoreHiddenSeries: false
            },
            // this removes the highcharts label/credit in the lower rt hand corner
            credits: {
              enabled: false
            },

            // this disables the built in print/exporting buttons to ensure the data is not sent to HCs servers

            exporting: {
              buttons: {
                contextButton: {
                  enabled: false
                }
              }
            },

            xAxis: {
              title: {
                text: "Dose (cGy)"
              },

              floor: 0.5,

              crosshair: true,

              maxPadding: 0.02
            },

            plotOptions: {
              series: {
                marker: {
                  enabled: false
                },

                allowPointSelect: true,

                states: {
                  hover: {
                    enabled: true,

                    lineWidth: 5
                  }
                }
              },

              boxplot: {
                fillColor: "#505053"
              },

              candlestick: {
                lineColor: "white"
              },

              errorbar: {
                color: "white"
              }
            },

            yAxis: {
              labels: {
                format: "{value} %"
              },

              floor: 0,

              ceiling: 100,

              title: {
                text: "Volume (%)"
              },

              crosshair: true,

              gridLineDashStyle: "ShortDash",

              gridLineColor: "#aaaaaa"
            },

            tooltip: {
              positioner: function() {
                return { x: 100, y: 0 };
              },

              shared: true,

              useHTML: true,

              // headerFormat: "<table>",

              // pointFormat:
              //   // original
              //   // '<tr><td style="color:{series.color}; text-shadow: -1px 0 #353839, 0 1px #353839, 1px 0 #353839, 0 -1px #353839;">{series.name}: </td><td style="text-align: left; color:#282827">V{point.x} cGy = {point.y:.3f} cc</td></tr>',
              //   '<tr><td style="color:#282827;">{series.name}: </td><td></td><td style="text-align: left; color:#282827">V{point.x} cGy = {point.y:.3f} cc</td></tr>',

              // footerFormat: "</table>"
              formatter: function() {
                var s =
                  '<table><strong style="color:#0a114a;">V' +
                  this.x +
                  " cGy:</strong>";

                // var sortedPoints = this.points.sort(function(a, b) {
                //     return a.y > b.y ? -1 : a.y < b.y ? 1 : 0;
                // });

                var sortedPoints = this.points.sort(function(a, b) {
                  return a.series.name < b.series.name
                    ? -1
                    : a.series.name > b.series.name
                    ? 1
                    : 0;
                });

                $.each(sortedPoints, function(i, point) {
                  if (point.y < 100 && point.y > 0) {
                    var last_ = point.series.name.lastIndexOf("_");
                    var plan = point.series.name.slice(0, last_);
                    var structure = point.series.name.slice(last_ + 1);
                    // s += '<tr><td style=\"color:' + point.series.color + '; text-shadow: -1px 0 #353839, 0 1px #353839, 1px 0 #353839, 0 -1px #353839;\">' + point.series.name + ': </td><td style=\"text-align: left; color:#282827\">&nbsp;&nbsp;&nbsp;&nbsp;' + Highcharts.numberFormat(point.y, 3, '.') + ' %</td></tr>';
                    s +=
                      // '<tr><td style="color:#0a114a;">' +
                      // point.series.name +
                      // ': </td><td style="text-align: left; color:#0a114a">&nbsp;&nbsp;&nbsp;&nbsp;' +
                      // Highcharts.numberFormat(point.y, 2, ".") +
                      // " %</td></tr>";
                      '<tr><td style="color:#0a114a;">' +
                      plan +
                      '</td><td style="color:#0a114a;">&nbsp;&nbsp;&nbsp;&nbsp;' +
                      structure +
                      '</td><td style="text-align: left; color:#0a114a">&nbsp;&nbsp;&nbsp;&nbsp;' +
                      Highcharts.numberFormat(point.y, 2, ".") +
                      "%</td></tr>";
                  }
                });
                s += "</table>";
                return s;
              }

              // NOTE: You can use the formatter toolip to format the data while hovering over various points. See documentation.

              //      I decided to sort them a different way but left this code as another example.

              //formatter: function() {

              //    var s = '<table><strong>V' + this.x + ' cGy:</strong>';

              //    var sortedPoints = this.points.sort(function (a, b) {

              //        return ((a.y > b.y) ? -1 : ((a.y < b.y) ? 1 : 0));

              //    });

              //    $.each(sortedPoints, function (i, point) {

              //        s += '<tr><td style=\"color:' + point.series.color + '; text-shadow: -1px 0 #353839, 0 1px #353839, 1px 0 #353839, 0 -1px #353839;\">' +

              //            point.series.name + ': </td><td style=\"text-align: left; color:#282827\">V' +

              //            point.x + ' cGy = ' + Highcharts.numberFormat(point.y, 1, '.') + ' %</td></tr>';

              //    });

              //    s += '</table>';

              //    return s;

              //}

              //<!--valueDecimals: 1-->
            },

            title: {
              text: "DVH",

              x: 0
            },

            subtitle: {
              text: "Click and drag to zoom in. Hold down shift key to pan.",

              x: 0
            },
            // use this to change position of legend
            legend: {
              align: "center",
              verticalAlign: "bottom",
              itemDistance: 50,
              itemStyle: {
                color: "#0a114a",
                fontWeight: "regular"
              },
              itemHiddenStyle: {
                color: "red"
              }
            },
            // legend: {
            //   align: "right",
            //   verticalAlign: "top",
            //   layout: "vertical",
            //   x: 0,
            //   y: 250,
            //   itemDistance: 50,
            //   itemStyle: {
            //     color: "#0a114a",
            //     fontWeight: "regular"
            //   },
            //   itemHiddenStyle: {
            //     color: "red"
            //   }
            // },
            // legend: {
            //   layout: "horizontal",

            //   align: "center",

            //   verticalAlign: "bottom",

            //   borderWidth: 0,

            //   floating: false,

            //   width: 420,

            //   itemWidth: 210,

            //   itemStyle: {
            //     width: 205
            //   },

            //   itemHiddenStyle: {
            //     color: "#ff4d4d"
            //   }
            // },

            // the settings for the individual series are defined below but loaded here

            series: seriesOptions2
          };

          chart = new Highcharts.Chart(options);
        }

        $(document).on("click", "#check-boxes input", function(e) {
          //send the chart object and the chartData object

          rebuildData();
        });

        $(document).on("click", "#loadPatientDiv input", function(e) {
          //send the chart object and the chartData object

          //alert('ok')

          init();

          buildCheckBoxes();

          //rebuildData();
        });

        function fill_seriesOptions(cat) {
          // body...

          var seriesOptionsHere = [];

          pertTypes2.forEach(function(ptype, h) {
            seriesOptionsHere.push({
              id: pertTypes2[h],

              name: pertTypes2[h],

              data: [],

              dashStyle: dashStyles[0],

              visible: true,

              color: "white"

              // linkedTo example: See Documentation

              //linkedTo: ':previous'
            });
          });

          planData.forEach(function(element, i) {
            element.structureData.forEach(function(childElement, j) {
              var category = cat.find(
                category => category.name === childElement.structureId
              );

              if (!category.visible) {
                return;
              }

              seriesOptionsHere.push({
                name: element.planId + "_" + childElement.structureId,

                data: childElement.dvh.sort(function(a, b) {
                  return a[0] - b[0];
                }),

                dashStyle: dashStyles[i],

                visible: true,

                color: childElement.structureColor,

                // here we can link each line to the same perturbationType defined in the JSON format

                // this allows us to turn on/off all the structures for a given perturbation type with one click

                // this was there is only one series for each pert type

                linkedTo: element.perturbationType
              });
            });
          });

          return seriesOptionsHere;
        }

        //this part is used to display the series categories, used for linkedTo, mush keep

        // data variables

        // functions that filter data and prepare it to be displayed

        function filterCategories() {
          var filteredCategories = [];

          $.each(contourCategories, function(i, category) {
            if (category.visible) {
              // push name only - chart.xAxis.categories requires array of String objects

              //filteredCategories.push(category.name);

              filteredCategories.push(category);
            }
          });

          return filteredCategories;
        }

        function filterSeries() {
          var filteredSeries = [];

          $.each(seriesOptions2, function(i, serie) {
            // serie options are merged during update,

            // so it's enough to initialize serie object only with data property

            var newSerie = {
              data: []
            };

            $.each(serie.data, function(i, point) {
              if (point.category.visible) {
                newSerie.data.push(point);
              }
            });

            filteredSeries.push(newSerie);
          });

          return filteredSeries;
        }

        //rebuild the chart data

        function rebuildData() {
          $.each($("#check-boxes input"), function(i, box) {
            var checkbox = this;

            //var category = originalCategories.find((category) => category.name === checkbox.id);

            var category = contourCategories.find(
              category => category.name === checkbox.id
            );

            category.visible = checkbox.checked;
            

          });

          $('#check-boxes input').click(function(){
            var checkbox = this;

            var category = contourCategories.find(
              category => category.name === checkbox.id
            );
            
            // $("#dvh-stats-table tr").filter(function() {
            //   $(this).toggle($(this).text().toLowerCase().indexOf(category.name.toLowerCase()) > -1)
            // });
          });

          var chart = $("#dvh").highcharts();
          
          // // var value = checkbox.val().toLowerCase();
          // $("#dvh-stats-table tr").filter(function() {
          //   $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          // });

          // while(chart.series.length > 0){

          //   //chart.series[0].remove(true);

          //   chart.series[0].remove(false);  //I think false means don't redraw, which increase speed

          // }

          

          var series_index = 0;

          //first a couple of the series are empty, for perterb types only

          pertTypes2.forEach(function(ptype, h) {
            series_index++;
          });

          planData.forEach(function(element, i) {
            element.structureData.forEach(function(childElement, j) {
              if (series_index < chart.series.length) {
                var category = contourCategories.find(
                  category => category.name === childElement.structureId
                );

                if (!category.visible) {
                  chart.series[series_index].setVisible(false, false);
                } else {
                  chart.series[series_index].setVisible(true, false);
                }

                series_index++;
              }
            });
          });

          // var newSerie = fill_seriesOptions(contourCategories)

          // var chart = $('#dvh').highcharts();

          // while(chart.series.length > 0){

          //   //chart.series[0].remove(true);

          //   chart.series[0].remove(false);  //I think false means don't redraw, which increases speed

          // }

          // newSerie.forEach((element, index, array) => {

          //   chart.addSeries(element,false);

          // });

          // chart.update({

          //   series: newSerie

          //   // xAxis: {

          //     categories: filterCategories()

          //   }

          // });

          chart.redraw();

          //chart = new Highcharts.Chart(options);
        }

        //create a checkbox for each category

        //build the list of checkboxes based on the categories

        function buildCheckBoxes() {
          $("#check-boxes ").empty();

          $.each(contourCategories, function(i, cat) {
            var box =
              '<label><input type="checkbox" onChange="filterDvhTable()" id="' +
              String(cat.name) +
              '" name="' +
              String(cat.name) +
              '" val="' +
              String(cat.name) +
              '" checked="checked" />' +
              String(cat.name) +
              "</label>";

            $("#check-boxes ").append(box);
          });
        }
      });

      // there are various options for line styles but we decided to use a solid line for the original plan and short dashes for the various perturbations.

      // there is likely an easier way to write this code

      var dashStyles = [
        "Solid",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash",

        "ShortDash"

        //'ShortDash',

        //'ShortDot',

        //'ShortDashDot',

        //'ShortDashDotDot',

        //'Dot',

        //'Dash',

        //'LongDash',

        //'DashDot',

        //'LongDashDot',

        //'LongDashDotDot'
      ];
    }
  }

  // filter the dvh table when structures are selected/unselected
  function filterDvhTable() {
    // adapted from https://stackoverflow.com/questions/28063963/how-to-filter-records-based-on-key-click
    if($('input[type="checkbox"]:checked').length > 0) {
      // Get ids of all checked boxes
      var ids = $('input[type="checkbox"]:checked').map(function() {
        return this.id;
      }).get();
      // Here we do two things to table rows
      // 1. We hide all
      // 2. Then we filter, show those whose value in first <td> matches checkbox value
      // Change: only hiding rows in the tbody, to keep header rows
      $('#dvh-stats-tbody tr')
      .hide()    // 1
      .filter(function() {    // 2
        return ids.indexOf($(this).find('td:first').text()) > -1;
      }).show();
    } else {
      // Hide all
      $('#dvh-stats-tbody tr').hide();
    }
  }

  /* ----- need to be able to re-size the dvh chart and the table to make printing worth while ----- */
  // in progress...

  // When printing, remove various buttons
  // function PrepareAndPrint() {
  //   $("#print").remove();

  //   $(".Buttons").remove();

  //   $(".loadPt").remove();

  //   $("#main-nav").remove();

  //   // $('#dvh').css('max-width', '500px');
  //   // var chart = $("#dvh").highcharts();
  //   // chart.redraw();

  //   window.print();
  // }
</script>

<!-- New Custom Style -->
<style>
  button#print {
    margin-top: 0;
    margin-left: 90%;
  }

  form#check-boxes label {
    /* color: red; */
    margin: auto;
    margin-left: 15px;
    text-align: center;
  }

  table th,
  table tbody {
    text-align: center;
  }

  /* fixed header for table with 6 columns */

.table-fixed-6 thead {
    width: calc(100% - 1em);
}

.table-fixed-6 tbody {
    height: 600px;
    overflow-y: auto;
    width: 100%;
}

.table-fixed-6 thead,
.table-fixed-6 tbody,
.table-fixed-6 tr,
.table-fixed-6 td,
.table-fixed-6 th {
    display: block;
    overflow: auto;
    /* width: 100%; */
}

.table-fixed-6 tbody td,
.table-fixed-6 thead>tr>th {
    float: left;
    border-bottom-width: 0;
    width: calc(100%/6);
}

table tbody tr:nth-child(even):hover,
table tbody tr:nth-child(odd):hover {
  background-color: #ccc;
}

</style>

<!-- bootstrap dashboard style -->
<style>
  body {
    font-size: 0.875rem;
  }

  .feather {
    width: 16px;
    height: 16px;
    vertical-align: text-bottom;
  }

  /*
 * Sidebar
 */

  .sidebar {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    z-index: 100; /* Behind the navbar */
    padding: 48px 0 0; /* Height of navbar */
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, 0.1);
  }

  .sidebar-sticky {
    position: relative;
    top: 0;
    height: calc(100vh - 48px);
    padding-top: 0.5rem;
    overflow-x: hidden;
    overflow-y: auto; /* Scrollable contents if viewport is shorter than content. */
  }

  @supports ((position: -webkit-sticky) or (position: sticky)) {
    .sidebar-sticky {
      position: -webkit-sticky;
      position: sticky;
    }
  }

  .sidebar .nav-link {
    font-weight: 500;
    color: #333;
  }

  .sidebar .nav-link .feather {
    margin-right: 4px;
    color: #999;
  }

  .sidebar .nav-link.active {
    color: #007bff;
  }

  .sidebar .nav-link:hover .feather,
  .sidebar .nav-link.active .feather {
    color: inherit;
  }

  .sidebar-heading {
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  /*
 * Content
 */

  [role="main"] {
    padding-top: 133px; /* Space for fixed navbar */
  }

  @media (min-width: 768px) {
    [role="main"] {
      padding-top: 48px; /* Space for fixed navbar */
    }
  }

  /*
 * Navbar
 */

  .navbar-brand {
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
    font-size: 1rem;
    background-color: rgba(0, 0, 0, 0.25);
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, 0.25);
  }

  .navbar .form-control {
    padding: 0.75rem 1rem;
    border-width: 0;
    border-radius: 0;
  }

  .form-control-dark {
    color: #fff;
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .form-control-dark:focus {
    border-color: transparent;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.25);
  }
</style>
